# Claude Worktree System - ì„¤ê³„ ëª…ì„¸ì„œ

## ê°œìš”
Git worktree ê¸°ë°˜ ë©€í‹° ë¸Œëœì¹˜ ê°œë°œ í™˜ê²½ì„ ì›¹ ëŒ€ì‹œë³´ë“œë¡œ ê´€ë¦¬í•˜ëŠ” ì‹œìŠ¤í…œ.
ê° ì›Œí¬íŠ¸ë¦¬ì˜ í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ë¥¼ ë…ë¦½ ì‹¤í–‰í•˜ê³ , í”Œëœ/ì§„í–‰ìƒí™©ì„ ì¤‘ì•™ ê´€ë¦¬í•œë‹¤.

## ê¸°ìˆ  ìŠ¤íƒ
- **Handler Server**: Next.js (ë…ë¦½ ì•±, localhost:3000)
- **ì›¹ í„°ë¯¸ë„**: xterm.js + node-pty + WebSocket
- **Git ì—°ë™**: child_process + chokidar (ë³€ê²½ ê°ì§€)
- **ëŒ€ìƒ í”„ë¡œì íŠ¸**: dynamos-v2 (Next.js)

---

## ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
~/worktree-handler/  (ë˜ëŠ” claude-worktree-system/)
â”œâ”€â”€ .env                          â† í™˜ê²½ ì„¤ì •
â”‚
â”œâ”€â”€ work-trees/
â”‚   â”œâ”€â”€ active.json               â† ì§„í–‰ì¤‘ ì›Œí¬íŠ¸ë¦¬ ëª©ë¡
â”‚   â”œâ”€â”€ deactive.json             â† ë¯¸ë“±ë¡ ë¸Œëœì¹˜ ëª©ë¡
â”‚   â””â”€â”€ ended.json                â† ì™„ë£Œëœ ì›Œí¬íŠ¸ë¦¬ ëª©ë¡
â”‚
â”œâ”€â”€ plan/
â”‚   â”œâ”€â”€ active/
â”‚   â”‚   â””â”€â”€ {branchName}/         â† ì§„í–‰ì¤‘ í”Œëœ (íŒŒì¼ ìˆ˜/í˜•íƒœ ì œí•œ ì—†ìŒ)
â”‚   â””â”€â”€ ended/
â”‚       â””â”€â”€ {branchName}/         â† ì™„ë£Œëœ í”Œëœ (ì•„ì¹´ì´ë¸Œ)
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                      â† í˜ì´ì§€ + API routes
â”‚   â””â”€â”€ lib/                      â† ìœ í‹¸ë¦¬í‹°
â”‚
â”œâ”€â”€ package.json
â””â”€â”€ next.config.ts
```

---

## í™˜ê²½ ë³€ìˆ˜ (.env)

```env
# ë©”ì¸ ë ˆí¬ ê²½ë¡œ
MAIN_REPO_PATH=/Users/ryokuman/Desktop/develop/1.inprogress/dynamos-v2

# ì›Œí¬íŠ¸ë¦¬ ìƒì„± ê¸°ë³¸ ê²½ë¡œ
WORKTREE_BASE_DIR=/Users/ryokuman/Desktop/develop/1.inprogress

# Handler ì„œë²„ í¬íŠ¸
HANDLER_PORT=3000

# ì›Œí¬íŠ¸ë¦¬ ì„œë²„ í¬íŠ¸ ë²”ìœ„
PORT_RANGE_START=3001
PORT_RANGE_END=3099

# í—¬ìŠ¤ì²´í¬ ê°„ê²© (ms)
HEALTHCHECK_INTERVAL=10000

# sudo í—ˆìš© ì—¬ë¶€
ALLOW_SUDO=false
```

---

## ì •ì˜ëœ ë™ì‘ ëª©ë¡

| #   | ë™ì‘               | ì£¼ì²´                      |
| --- | ------------------ | ------------------------- |
| A1  | git ë³€ê²½ ê°ì§€      | Handler Server (watcher)  |
| A2  | active/deactive ë¶„ë¥˜ | Handler Server (ìë™)    |
| A3  | ëŒ€ì‹œë³´ë“œ ì¡°íšŒ      | Handler Server (ì›¹)       |
| A4  | ì›Œí¬íŠ¸ë¦¬ ì¶”ê°€ (Add)| Handler Server (ì›¹)       |
| A5  | ì›¹ í„°ë¯¸ë„ ì˜¤í”ˆ     | Handler Server (xterm.js) |
| A6  | í”Œëœ ìƒì„±          | Claude Code (í„°ë¯¸ë„ ë‚´)   |
| A7  | ì›Œí¬íŠ¸ë¦¬ ìƒì„±      | Handler Server (ìë™)     |
| A8  | ì„œë²„ ì‹œì‘          | Handler Server (ì›¹)       |
| A9  | ì„œë²„ ì¤‘ì§€          | Handler Server (ì›¹)       |
| A10 | í—¬ìŠ¤ì²´í¬           | Handler Server (polling)  |
| A11 | í”Œëœ ìƒì„¸ ì¡°íšŒ     | Handler Server (ì›¹)       |
| A12 | í”Œëœ ìˆ˜ì •          | Handler Server (ì›¹)       |
| A13 | ì‘ì—… ì™„ë£Œ ì²˜ë¦¬     | Handler Server (ì›¹)       |
| C1  | í—¬ìŠ¤ì²´í¬ ì‘ë‹µ      | ê° ì›Œí¬íŠ¸ë¦¬ (Next.js API) |

---

## ë™ì‘ ìƒì„¸ ëª…ì„¸

### A1. git ë³€ê²½ ê°ì§€ & ë¸Œëœì¹˜ ìˆ˜ì§‘
```
íŠ¸ë¦¬ê±°:  .git ë””ë ‰í† ë¦¬ ë³€ê²½ ê°ì§€ (chokidar) ë˜ëŠ” ì£¼ê¸°ì  polling
ë™ì‘:    git branch -a ì‹¤í–‰ â†’ ì „ì²´ ë¸Œëœì¹˜ ëª©ë¡ ìˆ˜ì§‘
         git worktree list ì‹¤í–‰ â†’ í˜„ì¬ ì›Œí¬íŠ¸ë¦¬ ëª©ë¡ ìˆ˜ì§‘
ì¶œë ¥:    ë©”ëª¨ë¦¬ ë‚´ ìµœì‹  ë¸Œëœì¹˜/ì›Œí¬íŠ¸ë¦¬ ìƒíƒœ
```

### A2. active/deactive ë¶„ë¥˜
```
íŠ¸ë¦¬ê±°:  A1 ì™„ë£Œ í›„
ë™ì‘:    ë¸Œëœì¹˜ ëª©ë¡ vs active.json ë¹„êµ
         â†’ activeì— ì—†ëŠ” ë¸Œëœì¹˜ â†’ deactive.jsonì— ì‘ì„±
         â†’ activeì— ìˆëŠ”ë° ë¸Œëœì¹˜ ì‚­ì œëœ ê²½ìš° â†’ activeì—ì„œ ì œê±°
ì¶œë ¥:    work-trees/active.json, work-trees/deactive.json ê°±ì‹ 
```

### A3. ëŒ€ì‹œë³´ë“œ ì¡°íšŒ
```
íŠ¸ë¦¬ê±°:  localhost:3000 ì ‘ì†
ì…ë ¥:    active.json + ê° plan/active/{branch}/ + í—¬ìŠ¤ì²´í¬ ìƒíƒœ
ì¶œë ¥:    ì›Œí¬íŠ¸ë¦¬ ë¦¬ìŠ¤íŠ¸
         [taskNo taskName]  [progress]  [ì„œë²„ìƒíƒœ] [â–¶/â– ]
         - taskNo+taskName í´ë¦­ â†’ redirect localhost:{port}
         - progress í´ë¦­ â†’ í”Œëœ ìƒì„¸ í˜ì´ì§€
```

### A4. ì›Œí¬íŠ¸ë¦¬ ì¶”ê°€ (Add)
```
íŠ¸ë¦¬ê±°:  ëŒ€ì‹œë³´ë“œ [+ Add] í´ë¦­
ë™ì‘:    1. deactive.json ì¡°íšŒ
         2. SelectBoxì— ë¯¸ë“±ë¡ ë¸Œëœì¹˜ ëª©ë¡ í‘œì‹œ
         3. ìœ ì €ê°€ ë¸Œëœì¹˜ ì„ íƒ
ì¶œë ¥:    ì„ íƒëœ ë¸Œëœì¹˜ â†’ A5ë¡œ ì „ë‹¬
```

### A5. ì›¹ í„°ë¯¸ë„ â†’ Claude Code ì‹¤í–‰
```
íŠ¸ë¦¬ê±°:  A4ì—ì„œ ë¸Œëœì¹˜ ì„ íƒ ì™„ë£Œ
ë™ì‘:    1. xterm.js í„°ë¯¸ë„ ëª¨ë‹¬ ì˜¤í”ˆ
         2. node-ptyë¡œ PTY ìƒì„±
         3. WebSocket ì—°ê²°
         4. PTYì—ì„œ claude CLI ì‹¤í–‰
ì¶œë ¥:    ìœ ì €ê°€ Claude Codeì™€ ëŒ€í™” ê°€ëŠ¥í•œ ì›¹ í„°ë¯¸ë„
```

### A6. í”Œëœ ìƒì„±
```
íŠ¸ë¦¬ê±°:  A5 í„°ë¯¸ë„ ë‚´ì—ì„œ Claude Code ëŒ€í™”
ë™ì‘:    ìœ ì € â†” Claude ëŒ€í™”ë¡œ ì—…ë¬´ ëª…ì„¸ ì •ì˜
         Claudeê°€ plan/active/{branchName}/ ì— íŒŒì¼ ìƒì„±
         (md, json ë“± íŒŒì¼ ìˆ˜/í˜•íƒœ ì œí•œ ì—†ìŒ)
ì¢…ë£Œì¡°ê±´: ìœ ì €ê°€ ëŒ€í™” ì¢…ë£Œ ë˜ëŠ” Claudeê°€ í”Œëœ ì™„ë£Œ ì„ ì–¸
ì¶œë ¥:    plan/active/{branchName}/ ì— íŒŒì¼ë“¤ ìƒì„±ë¨
```

### A7. ì›Œí¬íŠ¸ë¦¬ ìƒì„± + íŒŒì¼ì „ë‹¬ + í¬íŠ¸ì„¤ì •
```
íŠ¸ë¦¬ê±°:  A6 ì™„ë£Œ (í„°ë¯¸ë„ ì¢…ë£Œ)
ë™ì‘:    1. git worktree add {path} {branch}
         2. plan/active/{branchName}/ ë‚´ íŒŒì¼ â†’ ì›Œí¬íŠ¸ë¦¬ì— ë³µì‚¬
         3. í¬íŠ¸ ìë™ í• ë‹¹ (PORT_RANGE_START ~ PORT_RANGE_END ì¤‘ ë¯¸ì‚¬ìš©)
         4. deactive.jsonì—ì„œ ì œê±°
         5. active.jsonì— ì¶”ê°€ (branch, path, port, status)
ì¶œë ¥:    ì›Œí¬íŠ¸ë¦¬ ìƒì„± ì™„ë£Œ, ëŒ€ì‹œë³´ë“œì— í‘œì‹œ
```

### A8. ì„œë²„ ì‹œì‘
```
íŠ¸ë¦¬ê±°:  ëŒ€ì‹œë³´ë“œ [â–¶] í´ë¦­
ë™ì‘:    1. npm install (node_modules ì—†ìœ¼ë©´)
         2. spawn("next dev -p {port}", cwd: worktreePath)
         3. PID + port â†’ active.json ê°±ì‹ 
         4. í—¬ìŠ¤ì²´í¬ polling ì‹œì‘
ì¶œë ¥:    status: "running"
```

### A9. ì„œë²„ ì¤‘ì§€
```
íŠ¸ë¦¬ê±°:  ëŒ€ì‹œë³´ë“œ [â– ] í´ë¦­
ë™ì‘:    kill(PID) â†’ active.json status â†’ "stopped"
ì¶œë ¥:    status: "stopped"
```

### A10. í—¬ìŠ¤ì²´í¬
```
íŠ¸ë¦¬ê±°:  ì£¼ê¸°ì  (HEALTHCHECK_INTERVAL)
ëŒ€ìƒ:    active.json ì¤‘ status: "running"
ë™ì‘:    GET localhost:{port}/api/healthz
         â†’ ì‘ë‹µ ì—†ìœ¼ë©´ status â†’ "stopped"
ì¶œë ¥:    ëŒ€ì‹œë³´ë“œ ìƒíƒœ ì‹¤ì‹œê°„ ë°˜ì˜
```

### A11. í”Œëœ ìƒì„¸ ì¡°íšŒ
```
íŠ¸ë¦¬ê±°:  ëŒ€ì‹œë³´ë“œ [progress] í´ë¦­
ì…ë ¥:    plan/active/{branchName}/ ì „ì²´ íŒŒì¼
ì¶œë ¥:    í”Œëœ ë‚´ íŒŒì¼ ëª©ë¡ + ë‚´ìš© í‘œì‹œ
```

### A12. í”Œëœ ìˆ˜ì •
```
íŠ¸ë¦¬ê±°:  í”Œëœ ìƒì„¸ í˜ì´ì§€ì—ì„œ í¸ì§‘
ë™ì‘:    1. plan/active/{branchName}/ ë‚´ íŒŒì¼ ìˆ˜ì •
         2. í•´ë‹¹ ì›Œí¬íŠ¸ë¦¬ì— ë³€ê²½ë¶„ ë™ê¸°í™”
ì¶œë ¥:    ëŒ€ì‹œë³´ë“œ progress ê°±ì‹ 
```

### A13. ì‘ì—… ì™„ë£Œ ì²˜ë¦¬
```
íŠ¸ë¦¬ê±°:  ëŒ€ì‹œë³´ë“œ [ì™„ë£Œ] ë²„íŠ¼
ë™ì‘:    1. ì„œë²„ ì¤‘ì§€ (runningì´ë©´)
         2. active.jsonì—ì„œ ì œê±° â†’ ended.jsonì— ì¶”ê°€
         3. plan/active/{branchName}/ â†’ plan/ended/{branchName}/ ì´ë™
         4. (ì„ íƒ) git worktree remove
ì¶œë ¥:    ëŒ€ì‹œë³´ë“œì—ì„œ ì‚¬ë¼ì§, ended ëª©ë¡ì—ì„œ ì¡°íšŒ ê°€ëŠ¥
```

### C1. í—¬ìŠ¤ì²´í¬ ì‘ë‹µ
```
ì—”ë“œí¬ì¸íŠ¸: GET /api/healthz
ì¶œë ¥:       { status: "ok", timestamp: ... }
ìœ„ì¹˜:       dynamos-v2 ë©”ì¸ ë ˆí¬ì— ì¶”ê°€ â†’ ì „ ì›Œí¬íŠ¸ë¦¬ ìë™ ì ìš©
íŒŒì¼:       src/app/api/healthz/route.ts
```

---

## ë°ì´í„° êµ¬ì¡°

### active.json
```json
[
  {
    "taskNo": "DV-494",
    "taskName": "LLM ì„¤ì • í˜ì´ì§€ ì •ìƒí™”",
    "branch": "feat/DV-494-LLM-ì„¤ì •-í˜ì´ì§€-ì •ìƒí™”",
    "path": "/Users/ryokuman/Desktop/develop/1.inprogress/dynamos-v2",
    "port": 3001,
    "status": "running",
    "pid": 12345,
    "createdAt": "2026-02-13"
  }
]
```

### deactive.json
```json
[
  {
    "branch": "feat/DV-500-ìƒˆê¸°ëŠ¥",
    "taskNo": "DV-500",
    "lastCommit": "abc1234",
    "updatedAt": "2026-02-13"
  }
]
```

### ended.json
```json
[
  {
    "taskNo": "DV-283",
    "taskName": "ê°œì¸í™” ê¸°ëŠ¥",
    "branch": "feat/DV-283-customization",
    "completedAt": "2026-02-10"
  }
]
```

---

## taskNo ê·œì¹™
- ë¸Œëœì¹˜ëª…ì— `DV-NNN` íŒ¨í„´ì´ ìˆìœ¼ë©´ ì¶”ì¶œí•˜ì—¬ ì‚¬ìš©
- ì—†ìœ¼ë©´ `TTN-1`, `TTN-2`, ... ìë™ ì¦ë¶„

---

## ëŒ€ì‹œë³´ë“œ UI ë ˆì´ì•„ì›ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dynamos Worktree Handler                        â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ DV-494 LLMì„¤ì •       (5/12)  â— [â–¶][â– ]   â”‚    â”‚
â”‚  â”‚  â†‘redirect            â†‘plan              â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ TTN-1 íƒ­ì‹œìŠ¤í…œ        (0/0)  â—‹ [â–¶]       â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ DV-500 ìƒˆê¸°ëŠ¥         (3/8)  â— [â– ]       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                  â”‚
â”‚  [+ Add]                          [ğŸ“‹ Ended]     â”‚
â”‚                                                  â”‚
â”‚  â— = running  â—‹ = stopped                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## í–¥í›„ í™•ì¥ ê°€ëŠ¥ì„±
- Storybook í¬íŠ¸ ê´€ë¦¬ (6006~)
- ì›Œí¬íŠ¸ë¦¬ ê°„ diff ë¹„êµ
- PR ìƒì„± ì—°ë™ (gh CLI)
- í”Œëœ ì§„í–‰ë¥  ìë™ ì¶”ì  (git commit ê¸°ë°˜)
